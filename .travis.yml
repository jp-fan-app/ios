os: osx
osx_image: xcode10.2
language: swift
branches:
  only:
  - "/^develop\\/.*$/"
  - master
env:
  global:
  - LC_CTYPE=en_US.UTF-8
  - LANG=en_US.UTF-8
  - PROFILE_NAME="JP_Performance_App_Store"
  - secure: aqmKhr4uXejX8/jtjWuCXFSgMTrelofyvP+ggT6zm49rJ+apA5/hYVumWrUZ36v1vXYLu3wdkm1uBHGKRhn/O0Fe4U6UnR9B2jwbVAzu9QQvQPKc+dsYHe2LfXaZdYGd9T+9RbOGSyZvSMNiZKW2nmhOVMmUyKfJi3zFjYghsL5Ci2NrPjF4OHLakSRuPdmAyltPl1F0lHoGVb8PoqPh9ylEP785PJ9po+ZhC+ig9EL2SjlZCA7h6yBl12OlKtSKJ13YRK2Msw9Wh15hYLWjF0gz5cyhFPbUY6qfEJTMXHwphUTlITpwAtKfeyly1GlaPeLZEu/RGPbo74l8KTYBsZEETIlXLu24r2T1wWbdHb6o6sC691cr6es9bZUxFfgb44DxhUMokx5bitAeNE06xavJl6TtPga3EzlBa4XTbXkwlXd9hcvAJUbUXHde1umSxnT9oZXGPyHrNjfN/l56TRsqt4cWxYFYecbVEEaN0N1pCXoYjdkhCPcejS7ot4psmXyR+g2O8Oc0u/GQlUfM6mCkn3Hjs+Hu5QvphP27mvvf27ET/81wtbZjY36Dve75ZJpm9th9Rgon5xP5Rx3WYvdD62jhClr4AZBZokLQum428r6IMCg4RrzPNA9pizv6JmvsUFYfHBEoq3TdeCyHreIvSkyU4L3s3l7fBuqqyvk=
  - secure: gnsZK79RROqKFisIFhWqginZR30qQpwl7SFy+luCsgorbleTokwM4LK5GvurymF7Kep+fwnmd/qj01pB/alx/NmCVhQ34oTa2WxxwmNdqmdRhxaHr2TXZ/0fysFbR7h2AAhoWv//wnGPxicnvVf1+apBH0eZaSuQgLNR0Kn5keiyruXiksFLZ12nvdtKUgQoS2XhPpQyqBIAT3clvEqjR4DxAAJHe9tJOFaOYcE7w4rGT9BAjvvdPts/LemKBbkN2QA/xx+sjF5E5UMt2vOOS/JdtxdY8Q8eDmHhl9mV+9mTShev44vJuXijsRzGY1CA8OTf7OQ0owBKUKfKE+Zf5r8J4NQtGNGAuPJOSrYhMp97yM63USkGvhEKo02Rc8ACBNBtQf1XBjymL26drS+KQPa9PsY/XECUwLI0aCCI1uUpx0HAjfDqSDcE7+Tl4PQ2ylSClY4oY6r8Lx+N5+XX4HSmNrnOSLoLSO3ePT4PtRha81ho13fAsQYJJetR07g+RO2m61JYt74Xf4qtLs5G+P4aRvdHvdIbQBmRX8KxzbduYCWS9k085gFFvH/kpN9d/3kavIHtDpJertYIREt0kB9VKCrRV8tUdP1UGG912VDLepfq/AwJuHaeMLp+taagIutkTOGlwAszUFt2Q9tmRLWFngdPnZCSHmkKGd5Yn0k=
git:
  submodules: false
stages:
- name: develop
  if: branch =~ ^develop/.*$
- name: master
  if: branch = master
jobs:
  include:
  - stage: develop
    name: Develop Job
    cache:
      cocoapods: true
      directories:
      - Carthage
    before_script:
    - "./scripts/add-key.sh"
    before_install:
    - openssl aes-256-cbc -K $encrypted_9841417654f4_key -iv $encrypted_9841417654f4_iv
      -in scripts/certs/dist.p12.enc -out scripts/certs/dist.p12 -d
    install:
    - gem install bundler -v 2.0.1
    - bundle install
    script:
    - fastlane dependencies
    - fastlane build_ipa
    after_script:
    - "./scripts/remove-key.sh"
    - "./scripts/write_homebrew_to_cache.sh mockturtle"
    deploy:
    - provider: script
      skip_cleanup: true
      script: fastlane deploy_develop
      on:
        all_branches: true
        condition: "$TRAVIS_BRANCH =~ ^develop\\/.*$"
  - stage: master
    name: Master Job
    before_script:
    - "./scripts/add-key.sh"
    install:
    - gem install bundler -v 2.0.1
    - bundle install
    script:
    - fastlane resign_current_version_from_s3_bucket
    after_script:
    - "./scripts/remove-key.sh"
    deploy:
    - provider: script
      skip_cleanup: true
      script: fastlane deploy_master
      on:
        all_branches: true
        condition: "$TRAVIS_BRANCH = master"
